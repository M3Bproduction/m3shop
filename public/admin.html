<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin | M3'Shop</title>
  <link rel="stylesheet" href="../css/style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<script>
  if (localStorage.getItem("isAdmin") !== "true") {
    window.location.href = "admin-login.html";
  }
</script>

<header class="top-nav">
  <div class="nav-logo">Admin - M3'Shop</div>
  <nav class="top-nav-links">
    <a href="../index.html">Accueil</a>
    <a href="products.html">Produits</a>
    <a onclick="logout()" class="btn btn-danger">Déconnexion</a>
  </nav>
</header>

<main class="admin-container">
  <h1>Gestion des Produits</h1>

  <form id="product-form">
    <input type="hidden" id="editIndex" value="">
    <label>Nom du produit :</label>
    <input type="text" id="name" required>

    <label>Prix (KMF) :</label>
    <input type="number" id="price" required>

    <label>Image (URL ou chemin local) :</label>
    <input type="text" id="image" required>

    <label>Description :</label>
    <textarea id="description" required></textarea>

    <button type="submit" class="btn">Enregistrer</button>
  </form>

  <h2>Produits enregistrés</h2>
  <div id="product-list" class="product-grid"></div>

  <h2>Commandes reçues</h2>
  <button class="btn btn-danger" onclick="supprimerToutesCommandes()">Supprimer toutes les commandes</button>
  <div id="orders-list" class="order-list"></div>
</main>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
  import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCDvLearVKssAytX518E6PmnIk0nNwhnIY",
    authDomain: "m3shop-d89ba.firebaseapp.com",
    databaseURL: "https://m3shop-d89ba-default-rtdb.firebaseio.com",
    projectId: "m3shop-d89ba",
    storageBucket: "m3shop-d89ba.appspot.com",
    messagingSenderId: "834427919228",
    appId: "1:834427919228:web:a5dae9f6692821782ea2f9",
    measurementId: "G-L2WEMND7ZZ"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const ordersList = document.getElementById("orders-list");

  function afficherCommandes() {
    const commandesRef = ref(db, "commandes");

    onValue(commandesRef, (snapshot) => {
      const data = snapshot.val();
      ordersList.innerHTML = "";

      if (!data) {
        ordersList.innerHTML = "<p>Aucune commande trouvée.</p>";
        return;
      }

      Object.entries(data).forEach(([key, order]) => {
        const div = document.createElement("div");
        div.className = "order-card";
        div.innerHTML = `
          <h4>Commande #${order.id}</h4>
          <p><strong>Client :</strong> ${order.client}</p>
          <p><strong>Téléphone :</strong> ${order.telephone}</p>
          <p><strong>Adresse :</strong> ${order.adresse}</p>
          <p><strong>Paiement :</strong> ${order.paiement}</p>
          <p><strong>Date :</strong> ${order.date}</p>
          <h5>Produits :</h5>
          <ul>
            ${order.produits.map(p => `
              <li>${p.name} × ${p.quantity} — <strong>${p.price * p.quantity} Ar</strong></li>
            `).join("")}
          </ul>
          <p><strong>Status :</strong> ${order.traite ? "✅ Traité" : "⏳ En attente"}</p>
          <button onclick="marquerCommeTraite('${key}')" class="btn">Marquer comme traité</button>
          <hr />
        `;
        ordersList.appendChild(div);
      });
    });
  }

  window.marquerCommeTraite = function (id) {
    const orderRef = ref(db, `commandes/${id}`);
    update(orderRef, { traite: true });
  };

  afficherCommandes();
</script>
</body>
</html>
